{% extends 'root.jinja2.html' %}
{# {% load header_category %} #}
{% block title %}Корзина{% if request.user %} пользователя - {{ request.user }}{% endif %}{% endblock %}
{% block content_center -%}
    <div id="show_cart" style="color:Black;text-align:left;">
    {% if user_cart_ %}
        <form method="POST" action="/корзина/пересчитать/">
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}"/>
            <input type="hidden" name="POST_NAME" value="recalc_cart"/>
            <table id="table_carts" cols="6" summary="Ваша корзина">
                <caption style="font-size:20px;">Ваша корзина</caption>
                <thead>
                    <tr>
                        {# <th scope="col" class="center">Фото</td> #}
                        <th scope="col">Наименование</th>
                        {# <th scope="col">Цвет</th> #}
                        {# <th scope="col">Размер</th> #}
                        {# <th scope="col" class="center"><p>Цена за штуку</p></td> #}
                        <th scope="col" style="width:68px;text-align:center;">Кол-во</th>
                        <th scope="col" style="text-align:center;">Сумма</th>
                        <th scope="col" style="text-align:center;">Удаление</th>
                    </tr>
                </thead>
                <tbody>
<script>
function CheckNumber(String){
	var Letters = ".,1234567890";
	var i;
	var c;
	for(i = 0; i < String.length; i ++){
		c = String.charAt( i );
		if (Letters.indexOf( c ) == -1){
			return true;
		}
	}
	return false;
}
var product_summ_of_quantity_array = new Array();
product_summ_of_quantity_array[0]=0;
//product_summ_of_quantity_array[999999]=0;
</script>
                    {# {% set products=user_cart_.products %} #}
                    {% for product in user_cart_.products %}
                    {% set real_product=product.product %}
<script>
var price_qty_array_{{ product.pk }} = new Array();
var price_array_{{ product.pk }} = new Array();
price_qty_array_{{ product.pk }}[0]=1;
price_array_{{ product.pk }}[0]={{ real_product.price|replace(",", ".") }};
{#  {% if discount1 != None %}
		{% if discount1.price %}
			{% for discount in discounts %}
				<!--{1% if not forloop.first %}-->
				{% if forloop.last %}
price_qty_array[{{ forloop.counter }}]={{ discount.quantity_of_products }};
price_array[{{ forloop.counter }}]={{ discount.price|replace(",", ".") }};
price_qty_array[{{ forloop.counter|add:"1" }}]=999;
price_array[{{ forloop.counter|add:"1" }}]={{ discount.price|replace(",", ".") }};
				<!--{1% endif %}-->
				{% else %}
price_qty_array[{{ forloop.counter }}]={{ discount.quantity_of_products }};
price_array[{{ forloop.counter }}]={{ discount.price|replace(",", ".") }};
				{% endif %}
			{% endfor %}
		{% else %}
		{% endif %}
	{% else %} #}
price_qty_array_{{ product.pk }}[1]=999;
price_array_{{ product.pk }}[1]={{ real_product.price|replace(",", ".") }};
	{# {% endif %} #}
function Calculate_{{ product.pk }}(operation){
	//var price=0.00;
	//var total=0.00;
	var Qut=$("#quantity1_{{ product.pk }}").val();
	//$("#quantity_order").val(Qut);
	$("#errorMsg").html('');
	if(CheckNumber(Qut)){
		//calculate();
		//alert('aaa'+Qut+'bbb');
		$("#errorMsg").html('Количество вводится цифрами!!!.');
		return false;
	}
	Qut=parseFloat(Qut);
	if(operation=='+'){Qut+={{ real_product.quantity_of_complete }}}
	if(operation=='-'){Qut-={{ real_product.quantity_of_complete }}}
	var minimal_quantity={{ real_product.minimal_quantity }}
	var quantity_of_complete={{ real_product.quantity_of_complete }};
	var intermediate_result=Qut-{{ real_product.minimal_quantity }};
	var result=intermediate_result%quantity_of_complete;
	//alert(result+' '+intermediate_result);
	if(result!=0&&intermediate_result!=0){
		//$("#errorMsg").html('Количество едениц товара в заказе должно быть кратно '+quantity_of_complete+' !!!');
		result=Math.ceil(intermediate_result/quantity_of_complete);
		Qut=(result*quantity_of_complete)+minimal_quantity;
	}
	if(Qut<{{ real_product.minimal_quantity }}){
		//$("#quantity").val({{ product.minimal_quantity }});
		//$("#quantity_order").val({{ product.minimal_quantity }});
		//calculate();
		//$("#errorMsg").html('Минимальное для заказа количество '+minimal_quantity+' !!!');
		Qut=minimal_quantity;
		//return false;
	}
	if(Qut>999){
		//$("#quantity").val(999);
		//$("#quantity_order").val(999);
		//calculate();
		//$("#errorMsg").html('Количество не может быть больше 999!!!');
        Qut=999;
		//return false;
	}
	$("#quantity1_{{ product.pk }}").val(Qut);
	$("#quantity2_{{ product.pk }}").val(Qut);
	$.each(price_qty_array_{{ product.pk }},function(i,val){
		if(val<=Qut&&Qut<price_qty_array_{{ product.pk }}[eval(i+1)]){
			//alert('i: '+i+' Qut: '+Qut+' val: '+val)
			var total=price_array_{{ product.pk }}[i]/{{ real_product.price_of_quantity }}*Qut;
			$("#summ_of_quantity_{{ product.pk }}").html(total.toFixed(2)+' грн.');
			product_summ_of_quantity_array[{{ product.pk }}]=total.toFixed(2);
		}
	});
	ReCalcSumm(false);
    return true;
}
function onChange_{{ product.pk }}(){
	window.setInterval("Calculate_{{ product.pk }}('|')",5000);
	//setTimeout(calculate(value),1500);
	return true;
}
</script>
                        <tr>
                            <td>
                                <input type="hidden"
                                       name="product_in_request_{{ product.pk }}"
                                       value="{{ product.pk }}"/>
                                <a href="{{ real_product.get_absolute_url() }}">
                                    {{ real_product.title }}
                                </a>
                            </td>
                            <td style="padding:0px;">
                                <li style="float:left;list-style-type:none;line-height:22px;">
                                    <a href="javascript:void(0)">
                                        <img src="/media/img/minus.gif"
                                            onClick="Calculate_{{ product.pk }}('-')" />
                                    </a>
                                </li>
                                <li style="float:left;list-style-type:none;line-height:22px;">
                                    <input id="quantity1_{{ product.pk }}"
                                           style="border:1px solid #CCCCCC;text-align:center;width:20px;padding:2px;"
                                           name="quantity_{{ product.pk }}" value="{{ product.quantity }}"
        								   onKeyUp="onChange_{{ product.pk }}();"
                                           type="text"/>
                                </li>
                                <li style="float:left;list-style-type:none;line-height:22px;">
                                    <a href="javascript:void(0)">
                                        <img src="/media/img/plus.gif"
                                            onClick="Calculate_{{ product.pk }}('+')" />
                                    </a>
                                </li>
                            </td>
                            {# {% set product_summ_of_quantity = product.summ_of_quantity %}
                            {% set real_product_price_of_quantity = real_product.price_of_quantity %}
                            {% set summ_of_quantity =  product_summ_of_quantity/real_product_price_of_quantity %} {{ summ_of_quantity }} #}
                            <td><p id="summ_of_quantity_{{ product.pk }}">{{ product.summ_of_quantity }} грн.</p></td>
<script>
product_summ_of_quantity_array[{{ product.pk }}]={{ product.summ_of_quantity|replace(",", ".") }};
</script>
                            <td style="text-align:center;">
                                <input id="delete1_{{ product.pk }}"
                                       name="delete_{{ product.pk }}"
                                       {# checked="" #}
                                       {# onchange="javascript:delete_on_off('delete1_{{ product.pk }}','delete2_{{ product.pk }}')" #}
                                       type="checkbox"/>
                            </td>
                        </tr>
                    {% endfor %}

{# <script>
function reselect_minus(IdString1, IdString2){
    var value = document.getElementById(IdString1).value
    if (value > 1 && value <= 999 ){
        document.getElementById(IdString1).value--;
        document.getElementById(IdString2).value--;
        ReCalcSumm();}
    return false;}
function reselect_plus(IdString1, IdString2){
    var value = document.getElementById(IdString1).value
    if (value >= 1 && value < 999 ){
        document.getElementById(IdString1).value++;
        document.getElementById(IdString2).value++;
        ReCalcSumm();}
    return false;} #}
<script>
function delete_on_off(IdString1, IdString2){
    var checked = document.getElementById(IdString1).checked
    document.getElementById(IdString2).checked = checked;
    return false;}
</script>
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="2"
                            style="text-align:right;">Сумма:</th>
                        <th colspan="2"
                            id="all_summ_of_quantity"
                            style="text-align:left;color:Fuchsia;font-size:18px;"></th>
                    </tr>
                </tfoot>
            </table>
            <input style="float:left;list-style-type:none;line-height:22px;"
                   type="submit"
                   value="Пересчитать корзину"/>
        </form>
        <form method="POST" action="/корзина/заказ/">
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}"/>
            <input type="hidden" name="POST_NAME" value="order_cart"/>
            {% for product in user_cart_.products %}
                <input id="quantity2_{{ product.pk }}"
                       name="quantity_{{ product.pk }}" value="{{ product.quantity }}"
                       type="hidden"/>
                <input id="delete2_{{ product.pk }}"
                       name="delete_{{ product.pk }}"
                       {# checked="" #}
                       type="hidden"/>
            {% endfor %}
            <input id="order_cart_input"
                   type="submit"
                   value="Оформить заказ"/>
        </form>
        <a href="/" title="Вернуться к покупкам">Продолжить покупки >></a>
<script>
function ReCalcSumm(change){
    var summ=0;
	$.each(product_summ_of_quantity_array,function(i){
        var val=parseFloat(product_summ_of_quantity_array[i])
        if(0<=val&&val<=999999){
            summ+=val;
        }
    });
    if(change==true){$("#all_summ_of_quantity").html(summ.toFixed(2)+' грн.');}
    if(parseInt(summ)<=200){$("#order_cart_input").prop("disabled",true);}
    else{$("#order_cart_input").prop("disabled",false);}
}
$(document).ready(ReCalcSumm(true));
</script>
    {% else %}
        <p>Ваша корзина пуста<br>
        <a href="/" title="Вернуться к покупкам">Продолжить покупки >></a></p>
    {% endif %}
    </div>
{%- endblock %}
